"""
–ß–∞—Å—Ç—å 1. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∏–±–µ—Ä—É–≥—Ä–æ–∑ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º VirusTotal API
–≠—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è (—á–∞—Å—Ç—å 1)
    –≠—Ç–∞–ø 1. –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞.
    - –ò—Å–ø–æ–ª—å–∑—É—è Python, —Ä–∞—Å–ø–∞–∫—É–π—Ç–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∞—Ä—Ö–∏–≤ –∏ –∏–∑–≤–ª–µ–∫–∏—Ç–µ —Ñ–∞–π–ª—ã.
    –≠—Ç–∞–ø 2. –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ VirusTotal API.
    - –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑, –∏—Å–ø–æ–ª—å–∑—É—è –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π API-–∫–ª—é—á VirusTotal.
    –≠—Ç–∞–ø 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
    - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç—ã –æ—Ç VirusTotal, —Å–æ–±–∏—Ä–∞—è –¥–∞–Ω–Ω—ã–µ –æ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —É–≥—Ä–æ–∑ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞–º–∏.
    –≠—Ç–∞–ø 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç—á—ë—Ç–∞. –°–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ç—á—ë—Ç —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –í–∫–ª—é—á–∏—Ç–µ –≤ –æ—Ç—á—ë—Ç –∫–æ–¥ —Å–∫—Ä–∏–ø—Ç–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ–≥–æ –≤—ã–≤–æ–¥–∞ –≤ –≤–∏–¥–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ (JPG, PNG).
    - –ü—Ä–∏–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ —É–≥—Ä–æ–∑—ã, –≤ —Ñ–æ—Ä–º–∞—Ç–µ: Detected, ALYac, Kaspersky.
    - –°—Ä–∞–≤–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤ –∏ –ø–µ—Å–æ—á–Ω–∏—Ü. –£–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–∏–µ –∏–∑ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤ (Fortinet, McAfee, Yandex, Sophos) –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ —É–≥—Ä–æ–∑—É, –∞ –∫–∞–∫–∏–µ –Ω–µ—Ç.
    –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
    ‚óè –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –æ—Ç—á—ë—Ç VirusTotal Sandbox –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –≤—Ä–µ–¥–æ–Ω–æ—Å–∞, –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –µ–≥–æ –∏ –≤–∫–ª—é—á–∏—Ç–µ –≤ —Å–≤–æ–π –æ—Ç—á—ë—Ç –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏–∑ –Ω–µ–≥–æ.
    ‚óè –í—ã–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –∏ IP-–∞–¥—Ä–µ—Å–æ–≤, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –≤—Ä–µ–¥–æ–Ω–æ—Å –æ–±—â–∞–µ—Ç—Å—è, (–¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏) –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è (Behavior) –æ—Ç VirusTotal Sandbox, –µ—Å–ª–∏ –æ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ.
"""
import time
from enum import StrEnum
from http import HTTPStatus
from typing import Any
from requests import post, get, exceptions
import zipfile

from settings import VIRUSTOTAL_API_KEY as API_KEY
from logger import Logger


class FileOperationCode(StrEnum):
    """
    –ö–æ–¥—ã —Å–æ–±—ã—Ç–∏–π –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ñ–∞–π–ª–∞
    """
    FILE_UPLOAD: str = "FILE UPLOAD"
    FILE_RESCAN: str = "FILE RESCAN"
    ANALYSE_REPORT: str = "ANALYSE REPORT"
    BEHAVIOURS_REPORT: str = "BEHAVIOURS REPORT"
    ANALYSE_FILE: str = "ANALYSE FILE"
    OUTPUT_REPORT: str = "OUTPUT REPORT"

class BaseAPI:
    """
    –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–∏—Å—É VirusTotal API
    https://virustotal-api-3-manual-rus.readthedocs.io/en/latest/endpoints.html
    """
    _BASE_URL_PART = "https://www.virustotal.com/api/v3"
    _SERVICE_URL_PART = ""

    def __init__(self, api_key: str):
        """
        –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        :param api_key: –∫–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        """
        self._api_key = api_key

    @property
    def api_key(self) -> str:
        """
        –ö–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        """
        return self._api_key

    @property
    def url(self) -> str:
        """
        –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ VirusTotal API
        """
        return f"{self._BASE_URL_PART}/{self._SERVICE_URL_PART}"

    @property
    def headers(self) -> dict[str, str]:
        """
        –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–ø—Ä–æ—Å–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∫–ª—é—á–æ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        """
        return {
            "accept": "application/json",
            "x-apikey": self.api_key
        }

class FilesAPI(BaseAPI):
    """
    –ö–ª–∞—Å—Å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ VirusTotal –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞
    https://docs.virustotal.com/reference/file
    """
    _SERVICE_URL_PART = 'files'

    def __init__(self, api_key: str, archive_filename: str, archive_password: str = None):
        """
        –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        :param api_key: –∫–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        :param archive_filename: –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ –∞—Ä—Ö–∏–≤–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ zip
        :param archive_password: –ø–∞—Ä–æ–ª—å –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É zip –∞—Ä—Ö–∏–≤—É –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏
        """
        super().__init__(api_key)
        self._archive_filename: str = archive_filename
        self._archive_password: str = archive_password

    @property
    def archive_filename(self) -> str | None:
        """
        –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ –∞—Ä—Ö–∏–≤–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ zip
        """
        return self._archive_filename

    @property
    def archive_password(self) -> str | None:
        """
        –ü–∞—Ä–æ–ª—å –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É zip –∞—Ä—Ö–∏–≤—É
        """
        return self._archive_password


    def upload_file(self) -> str | None:
        """
        –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∞–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª (Upload and analyse a file)
        [post] - https://www.virustotal.com/api/v3/files
        :return: ID –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞
        """
        operation = FileOperationCode.FILE_UPLOAD
        try:
            if not self.archive_filename:
                raise Exception(f"–ù–µ –∑–∞–¥–∞–Ω –∞—Ä—Ö–∏–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")
            if not zipfile.is_zipfile(self.archive_filename):
                raise Exception("Uploading archive is not a ZIP file")

            payload = {"password": self.archive_password} if self.archive_password else None
            try:
                with open(self.archive_filename, "rb") as file:
                    files = {"file": (self.archive_filename, file, "application/x-zip-compressed")}
                    #print(f"–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ {self.archive_filename} –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.  –û–∂–∏–¥–∞–π—Ç–µ...")
                    response = post(self.url, headers=self.headers, files=files, data=payload)
                    response.raise_for_status()
            except exceptions.HTTPError as http_err:
                raise Exception(f"HTTP –æ—à–∏–±–∫–∞: {http_err}")
            except exceptions.RequestException as err:
                raise Exception(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {err}")

            if response.status_code == HTTPStatus.OK:
                file_analyses = response.json()
                analyses_id = file_analyses["data"]["id"]
                return analyses_id
            else:
                raise Exception(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞: [statusCode: {response.status_code}] {response.text}")
        except Exception as ex:
            print(f"[-] {ex}")
            return None

    def rescan_file(self, analyses_id: str) -> str | None:
        """
        –ü–æ–≤—Ç–æ—Ä–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª –Ω–∞ –∞–Ω–∞–ª–∏–∑ –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ (Request a file rescan (re-analyze)  already in VirusTotal)
        [post] - https://www.virustotal.com/api/v3/files/{id}/analyse
        :param analyses_id: ID –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞
        :return: ID –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞
        """
        operation = FileOperationCode.FILE_RESCAN
        try:
            if not analyses_id:
                raise Exception(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞ (AnalysesID)")

            url = f"{self.url}/{analyses_id}/analyse"
            try:
                response = post(url, headers=self.headers)
                response.raise_for_status()
            except exceptions.HTTPError as http_err:
                raise Exception(f"HTTP –æ—à–∏–±–∫–∞: {http_err}")
            except exceptions.RequestException as err:
                raise Exception(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {err}")

            if response.status_code == HTTPStatus.OK:
                file_analyses = response.json()
                analyses_id = file_analyses["data"]["id"]
                return analyses_id
            else:
                raise Exception(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∞—Ä—Ö–∏–≤–∞: [statusCode: {response.status_code}] {response.text}")
        except Exception as ex:
            print(f"[-] {ex}")
            return None

    def behaviours_report(self, file_id: str) -> Any | None:
        """
        –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç –ø–æ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ –∏–∑ –∫–∞–∂–¥–æ–π –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ä–µ–¥—ã
        [get] - https://www.virustotal.com/api/v3/files/{id}/behaviours
        :param file_id: ID —Ñ–∞–π–ª–∞ SHA-256
        :return: –æ—Ç—á–µ—Ç –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏
        """
        operation = FileOperationCode.BEHAVIOURS_REPORT
        try:
            if not file_id:
                raise Exception(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∞–π–ª–∞ SHA-256 (FileID)")

            url = f"{self.url}/{file_id}/behaviours"
            while True:
                try:
                    response = get(url, headers=self.headers)
                    response.raise_for_status()
                except exceptions.HTTPError as http_err:
                    raise Exception(f"HTTP –æ—à–∏–±–∫–∞: {http_err}")
                except exceptions.RequestException as err:
                    raise Exception(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {err}")

                if response.status_code == HTTPStatus.OK:
                    behaviours_report = response.json()
                    return behaviours_report["data"]
                else:
                    raise Exception(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏: [statusCode: {response.status_code}] {response.text}")
        except Exception as ex:
            print(f"[-] {ex}")
            return None

class AnalysesAPI(BaseAPI):
    """
    –ö–ª–∞—Å—Å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ VirusTotal –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é —Ñ–∞–π–ª–∞
    https://docs.virustotal.com/reference/analysis
    """
    _SERVICE_URL_PART = 'analyses'

    def __init__(self, api_key: str, analyses_id: str):
        """
        –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        :param api_key: –∫–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        :param analyses_id: –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞ –∞—Ä—Ö–∏–≤–∞
        """
        super().__init__(api_key)
        self._analyses_id: str = analyses_id

    @property
    def analyses_id(self) -> str:
        """
        –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞ –∞—Ä—Ö–∏–≤–∞
        """
        return self._analyses_id

    def analyse_report(self) -> tuple[str, Any] | None:
        """
        –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ñ–∞–π–ª–∞ (Get a URL / file analyses)
        [get] - https://www.virustotal.com/api/v3/analyses/{id}
        :return: (ID —Ñ–∞–π–ª–∞, –æ—Ç—á–µ—Ç)
        """
        operation = FileOperationCode.ANALYSE_REPORT
        try:
            if not self.analyses_id:
                raise Exception(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞ (AnalysesID)")

            url = f"{self.url}/{self.analyses_id}"
            while True:
                try:
                    response = get(url, headers=self.headers)
                    response.raise_for_status()
                except exceptions.HTTPError as http_err:
                    raise Exception(f"HTTP –æ—à–∏–±–∫–∞: {http_err}")
                except exceptions.RequestException as err:
                    raise Exception(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: {err}")

                if response.status_code == HTTPStatus.OK:
                    analyse_report = response.json()
                    if analyse_report["data"]["attributes"]["status"] != "completed":
                        time.sleep(5)
                        continue
                    file_id = analyse_report["meta"]["file_info"]["sha256"]
                    report = analyse_report["data"]["attributes"]
                    return file_id, report
                else:
                    raise Exception(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ –∞–Ω–∞–ª–∏–∑—É –∞—Ä—Ö–∏–≤–∞: [statusCode: {response.status_code}] {response.text}")
        except Exception as ex:
            print(f"[‚òì] {ex}")
            return None


def analyze_file(api_key: str, archive_filename: str, archive_password: str = None, logger: Logger = None) -> dict[str, Any] | None:
    """
    –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    {'analyses_id', str} - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞ –∞—Ä—Ö–∏–≤–∞
    {'file_id', str} - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∞–π–ª–∞ SHA-256
    {'detected_avs', dict['antivirus','malware']} - –∞–Ω—Ç–∏–≤–∏—Ä—É—Å—ã –æ–±–Ω–∞—Ä—É–∂–∏–≤—à–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç—å
    {'threats', dict['malware','antiviruses']} - —É–≥—Ä–æ–∑ —Å –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞–º–∏
    {'hostnames', set} - –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ö–æ—Å—Ç—ã
    {'resolved_ips', set} - –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞
    {'mitre_attack_techniques', dict['id','signature_description']} - –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∞—Ç–∞–∫ MITTRE
    :param api_key: –∫–ª—é—á –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    :param archive_filename: –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ –∞—Ä—Ö–∏–≤–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ zip
    :param archive_password: –ø–∞—Ä–æ–ª—å –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É zip –∞—Ä—Ö–∏–≤—É –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏
    :param logger: –ª–æ–≥–≥–µ—Ä –æ–ø–µ—Ä–∞—Ü–∏–π
    :return: —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∞–Ω–∞–ª–∏–∑–∞ (analyses_id, file_id, detected_avs, threats, hostnames, resolved_ips, mitre_attack_techniques)
    """
    if not api_key or not archive_filename: return None

    try:
        print("–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞...")
        print("-" * 31 + "\n")

        # –ª–æ–≥–µ—Ä
        if not logger: logger = Logger(FileOperationCode.ANALYSE_FILE)
        else: logger.operation = FileOperationCode.ANALYSE_FILE

        # –∏—Ç–æ–≥–æ–≤—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∞–Ω–∞–ª–∏–∑–∞
        result = {
            "archive_filename": archive_filename
        }

        # –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ –∞–Ω–∞–ª–∏–∑
        files_api = FilesAPI(api_key, archive_filename, archive_password)
        analyses_id = files_api.upload_file()
        analyses_id = "NjEyYjU3ZTJhZmU3MDY1ZWJlOTIxMzM3MTcwZGY3ZDQ6MTc0MjIzOTg5NQ=="
        if not analyses_id:
            return None
        print(f"{logger.counter}. –ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –ø—Ä–æ—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω")
        print(f"---> –ü–æ–ª—É—á–µ–Ω –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞ –∞—Ä—Ö–∏–≤–∞ (analyses_id: {analyses_id})")
        result["analyses_id"] = analyses_id

        # —Ñ–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –ø–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é —Ñ–∞–π–ª–∞
        analyses_api = AnalysesAPI(API_KEY, analyses_id)
        analyses_res = analyses_api.analyse_report()
        if not analyses_res:
            return None
        file_id, file_report = analyses_res
        print(f"{logger.counter}. –û—Ç—á–µ—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∞—Ä—Ö–∏–≤–∞ —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω")
        print(f"---> –ü–æ–ª—É—á–µ–Ω –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∞–π–ª–∞ SHA-256 (file_id: {file_id})")
        result["file_id"] = file_id

        # –∞–Ω–∞–ª–∏–∑ –ø–µ—Å–æ—á–Ω–∏—Ü—ã
        # –∞–Ω—Ç–∏–≤–∏—Ä—É—Å—ã –æ–±–Ω–∞—Ä—É–∂–∏–≤—à–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç—å
        detected_avs = {}
        results = file_report["results"]
        if results:
            for antivirus, details in results.items():
                if details["category"] == "malicious":
                    detected_avs[antivirus] = details["result"]
            if len(detected_avs) > 0:
                print(f"---> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å–ø–∏—Å–æ–∫ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤ –æ–±–Ω–∞—Ä—É–∂–∏–≤—à–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç—å (detected_avs: {len(detected_avs)})")
                result["detected_avs"] = detected_avs

        # –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —É–≥—Ä–æ–∑—ã
        threats = {}
        if detected_avs:
            for avs, malware in detected_avs.items():
                antiviruses = threats.get(malware, set())
                antiviruses.add(avs)
                threats[malware] = antiviruses
            if len(threats) > 0:
                print(f"---> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å–ø–∏—Å–æ–∫ —É–≥—Ä–æ–∑ —Å –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞–º–∏ (threats: {len(threats)})")
                result["threats"] = threats

        # –∞–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è (–∏—â–µ–º —Ö–æ—Å—Ç—ã, IP –∞–¥—Ä–µ—Å–∞, –∞—Ç–∞–∫–∏ MITTRE)
        behaviours_report = files_api.behaviours_report(file_id)
        if behaviours_report:
            print(f"{logger.counter}. –û—Ç—á–µ—Ç –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω")
            hostnames = set()  # —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤
            resolved_ips = set()  # —Å–ø–∏—Å–æ–∫ –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤
            mitre_attack_techniques = dict()  # —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö–Ω–∏–∫ –∞—Ç–∞–∫ MITTRE
            for behaviour in behaviours_report:
                attributes = behaviour["attributes"]
                for attr_tag in ["dns_lookups", "mitre_attack_techniques"]:
                    if attr_tag in attributes:
                        for attr_data in attributes[attr_tag]:
                            # –Ω–∞—Ö–æ–¥–∏–º –∏–º–µ–Ω–∞ —Ö–æ—Å—Ç–æ–≤ –∏ IP –∞–¥—Ä–µ—Å–∞
                            if attr_tag == "dns_lookups":
                                if "hostname" in attr_data:
                                    hostnames.add(attr_data["hostname"])
                                if "resolved_ips" in attr_data:
                                    resolved_ips.update(attr_data["resolved_ips"])
                            # –Ω–∞—Ö–æ–¥–∏–º –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∞—Ç–∞–∫ MITTRE
                            elif attr_tag == "mitre_attack_techniques":
                                id = attr_data["id"]
                                signature_description = attr_data["signature_description"]
                                mitre_attack_techniques[id] = signature_description
            if len(hostnames) > 0:
                print(f"---> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å–ø–∏—Å–æ–∫ —Ö–æ—Å—Ç–æ–≤ (hostnames: {len(hostnames)})")
                result["hostnames"] = hostnames
            if len(resolved_ips) > 0:
                print(f"---> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å–ø–∏—Å–æ–∫ –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤ (resolved_ips: {len(resolved_ips)})")
                result["resolved_ips"] = resolved_ips
            if len(mitre_attack_techniques) > 0:
                print(f"---> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å–ø–∏—Å–æ–∫ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ MITTRE –∞—Ç–∞–∫ (mitre_attack_techniques: {len(mitre_attack_techniques)})")
                result["mitre_attack_techniques"] = mitre_attack_techniques

        return result
    except Exception as ex:
        print(f"[‚òì] –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞: {ex}")
        return None

def generate_report(analyse_result: dict[str, Any], output_filename: str = "virus_total_report.txt", target_avs: list | None = None, logger: Logger = None) -> None:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞
    :param analyse_result: —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∞–Ω–∞–ª–∏–∑–∞ (archive_filename, analyses_id, file_id, detected_avs, threats, hostnames, resolved_ips, mitre_attack_techniques)
    :param output_filename: –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Å –æ—Ç—á–µ—Ç–æ–º
    :param target_avs: —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–≤—ã—Ö –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    :param logger: –ª–æ–≥–≥–µ—Ä –æ–ø–µ—Ä–∞—Ü–∏–π
    """
    if not analyse_result or not output_filename: return

    try:
        # –ª–æ–≥–µ—Ä
        if not logger: logger = Logger(FileOperationCode.OUTPUT_REPORT)
        else: logger.operation = FileOperationCode.OUTPUT_REPORT

        filename = analyse_result["archive_filename"]
        analyses_id = analyse_result["analyses_id"]
        file_id = analyse_result["file_id"]
        detected_avs = analyse_result.get("detected_avs", {})
        threats = analyse_result.get("threats", {})
        hostnames = analyse_result.get("hostnames", set())
        resolved_ips = analyse_result.get("resolved_ips", set())
        mitre_attack_techniques = analyse_result.get("mitre_attack_techniques", {})

        with open(output_filename, "w", encoding="utf-8") as file:
            file.write("–û—Ç—á–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–∏–±–µ—Ä—É–≥—Ä–æ–∑\n")
            file.write("-" * 41 + "\n\n")

            file.write(f"–§–∞–π–ª: {filename}\n")
            file.write(f"Analyses ID: {analyses_id}\n")
            file.write(f"File ID: {file_id}\n")

            if detected_avs:
                file.write(f"\n–ê–Ω—Ç–∏–≤–∏—Ä—É—Å—ã –æ–±–Ω–∞—Ä—É–∂–∏–≤—à–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ ({len(detected_avs)}):\n{', '.join(sorted(detected_avs.keys()))}\n")
                if target_avs:
                    file.write("\n–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–µ–≤—ã—Ö –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤:\n")
                    for avs in target_avs:
                        is_detected = avs in detected_avs
                        check_sign = 'üó∏' if is_detected else '‚òì'
                        check_text = '–æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ' if is_detected else '–Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ'
                        file.write(f"  {u'\u25AA'} {avs}:  {check_sign} {check_text}\n")
            else:
                file.write("\n–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–º –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–∞–º\n")

            if threats:
                file.write(f"\n–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —É–≥—Ä–æ–∑—ã ({len(threats)}):\n")
                for threat, avs in sorted(threats.items()):
                    file.write(f"  {u'\u25AA'} [{threat}]: {', '.join(sorted(avs))}\n")
            else:
                file.write("\n–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–º —É–≥—Ä–æ–∑–∞–º\n")

            if hostnames or resolved_ips:
                if hostnames:
                    file.write(f"\n–î–æ–º–µ–Ω—ã ({len(hostnames)}):\n")
                    for host in sorted(hostnames):
                        file.write(f"  {u'\u25AA'} {host}\n")
                if resolved_ips:
                    file.write(f"\nIP –∞–¥—Ä–µ—Å–∞ ({len(resolved_ips)}):\n")
                    for ip in resolved_ips:
                        file.write(f"  {u'\u25AA'} {ip}\n")
            else:
                file.write("\n–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ—Ç–µ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n")

            if mitre_attack_techniques:
                if mitre_attack_techniques:
                    file.write(f"\nMITRE Attack Techniques ({len(mitre_attack_techniques)}):\n")
                    for attack_id, signature_description in sorted(mitre_attack_techniques.items()):
                        file.write(f"  {u'\u25AA'} [{attack_id}]: {signature_description}\n")
            else:
                file.write("\n–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–≤–µ–¥–µ–Ω–∏—é")

            print(f"[{logger.counter}] –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –æ—Ç—á–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–∏–±–µ—Ä—É–≥—Ä–æ–∑: {output_filename}")
    except Exception as ex:
        print(f"[‚òì] –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–∏–±–µ—Ä—É–≥—Ä–æ–∑: {ex}")
        return None


if __name__ == "__main__":
    ARCHIVE_FILENAME = "protected_archive.zip"
    ARCHIVE_PASSWORD = "netology"
    TARGET_AVS = ["Fortinet", "McAfee", "Yandex", "Sophos"]

    try:
        logger = Logger()
        analyse_result = analyze_file(API_KEY, ARCHIVE_FILENAME, ARCHIVE_PASSWORD, logger)
        if analyse_result:
            generate_report(analyse_result, "virus_total_file_report.txt", TARGET_AVS, logger)
    except KeyboardInterrupt:
        print("\n–ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º...")
    except Exception as ex:
        print(ex)